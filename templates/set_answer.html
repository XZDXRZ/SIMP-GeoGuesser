<!doctype html>
<html><head>
  <meta charset="utf-8" />
  <title>Round {{ round_num }} Answer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#101828; --muted:#475467;
      --border:#e4e7ec; --accent:#2563eb; --accent2:#1d4ed8;
      --good:#067647; --bad:#b42318; --radius:14px;
    }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background: linear-gradient(180deg, #f6f7fb, #eef2ff); padding:24px 18px; }
    .wrap{max-width:1200px; margin:0 auto;}
    .card{ background: var(--card); border-radius: var(--radius); padding: 18px; border: 1px solid var(--border); }
    img{max-width:100%; border-radius:12px; border:1px solid var(--border); cursor: crosshair;}
    .muted{color:var(--muted);}
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background: var(--accent); color:white; cursor:pointer; font-weight:900; }
    button:hover{background: var(--accent2);}
    a{color:var(--accent); text-decoration:none; font-weight:900;}
    .xy{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .tag{
      display:inline-flex; padding: 4px 10px; border-radius: 999px;
      background: #eff6ff; color: #1d4ed8; font-weight: 800; font-size: 12px; border: 1px solid #dbeafe;
    }
  </style>
</head><body>
  <div class="wrap">
    <h1 style="margin:0 0 6px 0; font-size:24px; letter-spacing:-0.02em;">Set the correct answer spot</h1>
    <p class="muted" style="margin:0 0 14px 0;">Click on the map, then save.</p>

    <div class="card">
        <div class="tag">Map</div>
        <p class="muted" style="margin:10px 0 10px 0;">
            Selected: <span class="xy" id="xy">(none)</span>
        </p>

        <div id="toast" style="
          position: fixed;
          right: 18px;
          bottom: 18px;
          display:none;
          z-index: 9999;
          padding: 10px 12px;
          border-radius: 12px;
          background: var(--card);
          border: 1px solid var(--border);
          color: var(--text);
          font-weight: 900;
          box-shadow: 0 10px 30px rgba(16,24,40,0.18);
        "></div>

        <div id="mapWrap" style="position:relative; display:block; width:100%; max-width:1200px;">
            <img id="map" src="{{url_for('uploads', filename=map_fn)}}" />
            <svg id="pinSvg"
                 style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;">
            </svg>
        </div>

        <form id="answerForm" method="post"
              style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <input type="hidden" name="x" id="x" />
            <input type="hidden" name="y" id="y" />
            <button type="submit">Save answer</button>
            <a href="{{url_for('host')}}">Cancel</a>
        </form>
    </div>
  </div>

  <script>
      (function () {
          const img = document.getElementById("map");
          const xInput = document.getElementById("x");
          const yInput = document.getElementById("y");
          const xy = document.getElementById("xy");
          const form = document.getElementById("answerForm");
          const toast = document.getElementById("toast");
          const svg = document.getElementById("pinSvg");

          function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

          function drawAnswerPin(x, y) {
              if (!svg || !img.naturalWidth || !img.naturalHeight) return;

              const rect = img.getBoundingClientRect();
              const w = rect.width;
              const h = rect.height;

              svg.setAttribute("width", w);
              svg.setAttribute("height", h);
              svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

              const scaleX = w / img.naturalWidth;
              const scaleY = h / img.naturalHeight;

              const cx = clamp(Math.round(x * scaleX), 0, w);
              const cy = clamp(Math.round(y * scaleY), 0, h);

              svg.innerHTML = `
                <g>
                    <path d="M ${cx} ${cy + 11} L ${cx - 6} ${cy + 25} L ${cx + 6} ${cy + 25} Z"
                        fill="rgba(220,38,38,0.98)" stroke="rgba(16,24,40,0.18)" stroke-width="2"></path>
                    <circle cx="${cx}" cy="${cy}" r="11" fill="rgba(255,255,255,0.98)"
                            stroke="rgba(16,24,40,0.18)" stroke-width="2"></circle>
                    <circle cx="${cx}" cy="${cy}" r="4" fill="rgba(220,38,38,0.98)"
                            stroke="rgba(16,24,40,0.18)" stroke-width="1"></circle>
                </g>
                `;
          }

          function redrawIfSelected() {
              if (xInput.value && yInput.value) {
                  drawAnswerPin(Number(xInput.value), Number(yInput.value));
              } else if (svg) {
                  svg.innerHTML = "";
              }
          }

          window.addEventListener("resize", redrawIfSelected);
          img.addEventListener("load", redrawIfSelected);
          setTimeout(redrawIfSelected, 0);
          function showToast(msg) {
              toast.textContent = msg;
              toast.style.display = "block";
              toast.style.opacity = "1";
              toast.style.transform = "translateY(0)";
              toast.style.transition = "opacity 250ms ease, transform 250ms ease";

              clearTimeout(showToast._t1);
              clearTimeout(showToast._t2);

              // start fade after a moment
              showToast._t1 = setTimeout(() => {
                  toast.style.opacity = "0";
                  toast.style.transform = "translateY(6px)";
              }, 1100);

              // hide after fade
              showToast._t2 = setTimeout(() => {
                  toast.style.display = "none";
              }, 1500);
          }

          // pick coordinates
          img.addEventListener("click", (e) => {
              const rect = img.getBoundingClientRect();
              const x = Math.round((e.clientX - rect.left) * (img.naturalWidth / rect.width));
              const y = Math.round((e.clientY - rect.top) * (img.naturalHeight / rect.height));
              xInput.value = x;
              yInput.value = y;
              xy.textContent = `(${x}, ${y})`;
              drawAnswerPin(x, y);
          });

          form.addEventListener("submit", (e) => {
              if (!xInput.value || !yInput.value) {
              e.preventDefault();
              showToast("Pick a spot on the map first");
              return;}
    //allow normal form submit (server redirects back to host)
          });
      })();
  </script>
</body></html>
